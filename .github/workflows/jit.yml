name: Optimizations and JIT Benchmarks

on:
  workflow_dispatch:

jobs:
  benchmark:
    runs-on: windows-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Setup MSYS2 (MinGW + Ninja)
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja

    - name: Add MinGW to PATH
      shell: bash
      run: |
        echo "$MINGW_PREFIX/bin" >> $GITHUB_PATH

    - name: Build C# Compiler
      shell: pwsh
      run: |
        dotnet restore Compiler/Compiler.csproj
        dotnet publish Compiler/Compiler.csproj -c Release -o build/compiler

    - name: Build C++ VM
      shell: bash
      run: |
        cmake -S virtual-machine -B build/vm -G Ninja -DCMAKE_BUILD_TYPE=Release
        cmake --build build/vm

    - name: Benchmark merge_sort (JIT vs no-JIT)
      shell: pwsh
      run: |
        $compiler = Join-Path $PWD "build\compiler\Compiler.exe"
        $vm = Join-Path $PWD "build\vm\czffvm.exe"

        $sources = @(
          Join-Path $PWD "test_files\merge_sort.czff"
          Join-Path $PWD "test_files\sieve_w_func.czff"
        )
        
        foreach ($source in $sources) {
          $name = [System.IO.Path]::GetFileNameWithoutExtension($source)
          $target = Join-Path $PWD "build\$name.ball"

          if (!(Test-Path $source)) {
              Write-Host "Test file not found: $source" -ForegroundColor Red
              exit 1
          }

          Write-Host ""
          Write-Host "=== Compiling $name ===" -ForegroundColor Cyan

          & $compiler -s "$source" -t "$target"
          if ($LASTEXITCODE -ne 0) {
              Write-Host "Compilation failed for $name" -ForegroundColor Red
              exit 1
          }

          Write-Host ""
          Write-Host "=== Running $name with JIT ===" -ForegroundColor Cyan

          $jitTimer = [System.Diagnostics.Stopwatch]::StartNew()
          & $vm -p "$target"
          $jitTimer.Stop()

          if ($LASTEXITCODE -ne 0) {
              Write-Host "JIT run failed for $name" -ForegroundColor Red
              exit 1
          }

          Write-Host ""
          Write-Host "=== Running $name without JIT ===" -ForegroundColor Cyan

          $nojitTimer = [System.Diagnostics.Stopwatch]::StartNew()
          & $vm -p "$target" --no-jit
          $nojitTimer.Stop()

          if ($LASTEXITCODE -ne 0) {
              Write-Host "no-JIT run failed for $name" -ForegroundColor Red
              exit 1
          }

          Write-Host ""
          Write-Host "=== Benchmark results for $name ===" -ForegroundColor Green
          Write-Host "JIT time:     $([math]::Round($jitTimer.Elapsed.TotalMilliseconds, 2)) ms" -ForegroundColor Yellow
          Write-Host "no-JIT time:  $([math]::Round($nojitTimer.Elapsed.TotalMilliseconds, 2)) ms" -ForegroundColor Yellow

          $speedup = $nojitTimer.Elapsed.TotalMilliseconds / $jitTimer.Elapsed.TotalMilliseconds
          Write-Host "Speedup:     x$([math]::Round($speedup, 2))" -ForegroundColor Cyan

          Remove-Item $target -Force
        }
    - name: Benchmark merge_sort (JIT vs no-JIT)
      shell: pwsh
      run: |
        $compiler = Join-Path $PWD "build\compiler\Compiler.exe"
        $vm = Join-Path $PWD "build\vm\czffvm.exe"

        $sources = @(
            Join-Path $PWD "test_files\optimizations.czff"
        )

        foreach ($source in $sources) {
            $name = [System.IO.Path]::GetFileNameWithoutExtension($source)
            $target = Join-Path $PWD "build\$name.ball"

            if (!(Test-Path $source)) {
                Write-Host "Test file not found: $source" -ForegroundColor Red
                exit 1
            }

            # ============================
            # Compile WITHOUT optimizations
            # ============================

            Write-Host ""
            Write-Host "=== Compiling $name (no optimizations) ===" -ForegroundColor Cyan

            & $compiler -s "$source" -t "$target"
            if ($LASTEXITCODE -ne 0) {
                Write-Host "Compilation failed for $name (no opts)" -ForegroundColor Red
                exit 1
            }

            Write-Host "=== Running $name (no optimizations) ===" -ForegroundColor Cyan

            $noOptsTimer = [System.Diagnostics.Stopwatch]::StartNew()
            & $vm -p "$target" --no-jit
            $noOptsTimer.Stop()

            if ($LASTEXITCODE -ne 0) {
                Write-Host "VM run failed for $name (no opts)" -ForegroundColor Red
                exit 1
            }

            Remove-Item $target -Force


            # ============================
            # Compile WITH optimizations
            # ============================

            Write-Host ""
            Write-Host "=== Compiling $name (CF + DCE) ===" -ForegroundColor Cyan

            & $compiler -s "$source" -t "$target" --use-cf --use-dce
            if ($LASTEXITCODE -ne 0) {
                Write-Host "Compilation failed for $name (CF+DCE)" -ForegroundColor Red
                exit 1
            }

            Write-Host "=== Running $name (CF + DCE) ===" -ForegroundColor Cyan

            $optTimer = [System.Diagnostics.Stopwatch]::StartNew()
            & $vm -p "$target" --no-jit
            $optTimer.Stop()

            if ($LASTEXITCODE -ne 0) {
                Write-Host "VM run failed for $name (CF+DCE)" -ForegroundColor Red
                exit 1
            }

            Remove-Item $target -Force


            # ============================
            # Results
            # ============================

            Write-Host ""
            Write-Host "=== Optimization benchmark for $name ===" -ForegroundColor Green
            Write-Host "No optimizations: $([math]::Round($noOptsTimer.Elapsed.TotalMilliseconds, 2)) ms" -ForegroundColor Yellow
            Write-Host "CF + DCE:        $([math]::Round($optTimer.Elapsed.TotalMilliseconds, 2)) ms" -ForegroundColor Yellow

            $speedup = $noOptsTimer.Elapsed.TotalMilliseconds / $optTimer.Elapsed.TotalMilliseconds
            Write-Host "Speedup:         x$([math]::Round($speedup, 2))" -ForegroundColor Cyan
        }


